<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>东北地区运输公司飞行人员生理性疲劳评估量化指标</title>
  <style>
:root {
  --primary-color: #005BAC;         /* 民航深蓝色 */
  --success-color: #1ABC9C;         /* 活力绿松石 */
  --bg-light: #f4f7fa;              /* 背景淡灰蓝 */
  --bg-white: #ffffff;
  --border-color: #cfd9e1;
  --text-color: #2c3e50;            /* 钛灰色 */
  --font-family: "Helvetica Neue", "PingFang SC", Arial, sans-serif;
}
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: var(--font-family); background: var(--bg-light); color: var(--text-color); padding: 20px; }
    header, nav, main, section { margin-bottom: 20px; }
    header h1 { text-align: center; margin-bottom: 20px; }
    nav { display: flex; border-bottom: 2px solid var(--primary-color); }
    .tab { background: none; border: none; padding: 12px 24px; cursor: pointer; font-size: 16px; color: #555; }
    .tab[aria-selected="true"] { border-bottom: 4px solid var(--primary-color); font-weight: bold; color: var(--primary-color); }
    .tabpanel { display: none; padding-top: 10px; }
    .tabpanel:not([hidden]) { display: block; }
    .instructions { background: var(--bg-white); border: 1px solid var(--border-color); border-radius: 4px; padding: 16px; font-size: 10px; line-height: 1.6; margin-bottom: 20px; }
    .instructions ol { padding-left: 1.5em; }
    .instructions ol ol { padding-left: 2em; }
    .instructions ol ol ol { padding-left: 2.5em; }
    .instructions ol ol ol ol { padding-left: 3em; }
    .instructions ol li { margin-bottom: 0.5em; }
    .info-form {
  display: flex;
  flex-wrap: wrap;
  gap: 20px;
  background: var(--bg-white);
  border: 1px solid var(--border-color);
  border-radius: 12px;
  padding: 24px;
  margin-bottom: 20px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
}
    .info-form label { display: flex; flex-direction: column; font-size: 14px; }
    .info-form input, .info-form select { margin-top: 4px; padding: 6px 8px; border: 1px solid var(--border-color); border-radius: 4px; }
    .yesno {display: flex;justify-content: center;  /* 水平居中 */align-items: center;gap: 8px;width: 100%;}
    table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
    table caption { font-weight: bold; margin-bottom: 8px; text-align: left; }
    table thead {
  background: linear-gradient(to right, #005BAC, #0074D9);
  color: white;
}
table tbody tr:hover {
  background-color: #eef4fc;
}
    th, td { border: 1px solid var(--border-color); padding: 10px; text-align: center; font-size: 14px; vertical-align: middle; }
    tfoot td { font-weight: bold; background: #f0f0f0; }
    fieldset.voting { background: var(--bg-white); border: 1px solid var(--border-color); border-radius: 4px; padding: 16px; margin-bottom: 20px; }
    fieldset.voting legend { font-size: 14px; margin-bottom: 8px; }
    fieldset.voting label { margin-right: 20px; font-size: 14px; display: inline-block; }
    .symptom-table { margin-bottom: 20px; }
    .symptom-table caption { font-weight: bold; margin-bottom: 8px; text-align: left; }
    button {
  font-size: 14px;
  transition: background 0.3s ease, transform 0.2s ease;
}
button:hover {
  transform: translateY(-1px);
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
}

    #exportBtn, #mergeBtn { padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; }
    #exportBtn { background: var(--success-color); color: var(--bg-white); margin-bottom: 20px; }
    #mergeBtn { background: var(--success-color); color: var(--bg-white); }
    input[type="file"] { margin-bottom: 10px; }
.email-info {
  margin-top: 0px;      /* 和按钮之间留点空 */
  color: #555;           /* 灰色字体，温和醒目 */
  font-size: 14px;
  font-family: Arial, sans-serif;
  word-break: break-all; /* 防止邮箱地址太长换行 */
}
@media (max-width: 768px) {
  body {
    padding: 10px;
  }

  .info-form {
    flex-direction: column;
    padding: 16px;
  }

  .info-form label {
    width: 100%;
  }

  .yesno {
    flex-direction: row;
    justify-content: space-around;
  }

  table {
    font-size: 12px;
  }

  th, td {
    padding: 6px;
  }

  .tab {
    font-size: 14px;
    padding: 8px 12px;
    flex: 1;
  }

  nav {
    flex-wrap: wrap;
  }

  .email-info {
    font-size: 12px;
    word-break: break-word;
  }

  #toast {
    bottom: 20px;
    width: calc(100% - 40px);
    max-width: 360px;
    font-size: 14px;
  }
}
.table-container {
  width: 100%;
  overflow-x: auto;
}
.form-line {
  display: flex;
  align-items: center;
  gap: 12px;
  flex-wrap: wrap;
  margin-bottom: 12px;
}

.form-title {
  min-width: 120px;
  font-size: 15px;
  color: var(--text-color);
}

.radio-group {
  display: flex;
  gap: 24px;
  font-size: 15px;
}
.radio-group input[type="radio"] {
  transform: scale(1.2);
  margin-right: 6px;
}
.radio-group input[type="radio"]:checked {
  accent-color: var(--primary-color);  /* 支持多数现代浏览器 */
}
.alert-box {
  border-left: 6px solid;
  padding: 16px 20px;
  margin-bottom: 20px;
  border-radius: 8px;
  font-size: 15px;
  line-height: 1.6;
  box-shadow: 0 2px 8px rgba(0,0,0,0.03);
}
.alert-box.inline-note {
  background-color: #f0f8ff;
  border-left: 4px solid #3498db;
  padding: 10px 16px;
  margin: 10px 0 16px 0;
  border-radius: 6px;
  font-size: 14px;
  color: #2c3e50;
  animation: breathe 4s ease-in-out infinite;
}

.alert-box.info {
  background-color: #f0f8ff;
  border-color: #3498db;
  color: #2c3e50;
  animation: breathe 4s ease-in-out infinite;
}

.alert-box:hover {
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}
.voting-enhanced {
  border: 1px solid var(--primary-color);
  border-radius: 10px;
  background: #f8fbff;
  padding: 20px;
  margin-bottom: 24px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.05);
}

.voting-enhanced legend {
  font-size: 15px;
  font-weight: 600;
  margin-bottom: 12px;
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  color: #2c3e50;
}

.legend-title {
  color: var(--primary-color);
}

.legend-note {
  font-size: 13px;
  color: #555;
}

.radio-options {
  display: flex;
  flex-wrap: wrap;
  gap: 24px;
  margin-top: 8px;
  font-size: 15px;
}

.radio-options input[type="radio"] {
  accent-color: var(--primary-color);
  transform: scale(1.1);
  margin-right: 4px;
}
@keyframes breathe {
  0% {
    transform: scale(1);
    box-shadow: 0 0 0 rgba(52,152,219,0.0);
  }
  50% {
    transform: scale(1.01);
    box-shadow: 0 0 12px rgba(52,152,219,0.3);
  }
  100% {
    transform: scale(1);
    box-shadow: 0 0 0 rgba(52,152,219,0.0);
  }
}
.alert-title {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 6px;
}

.icon-info {
  flex-shrink: 0;
}

.alert-message {
  line-height: 1.6;
}

  </style>
</head>
<body>
<header>
<h1 style="
  text-align:center;
  font-size: 23px;
  color: #005BAC;
  border: 2px solid #007BFF;
  padding: 12px 16px;
  border-radius: 8px;
  background-color: #f0f8ff;
  box-shadow: 0 0 10px rgba(0, 123, 255, 0.2);
  font-weight: bold;
  display: inline-block;
  margin: 20px auto;
  width: 100%;
">
  东北地区运输公司飞行人员<br>生理性疲劳评估量化指标
</h1>

</header>
  <nav role="tablist" aria-label="选项卡">
    <button role="tab" class="tab" id="tab1-btn" aria-selected="true" aria-controls="tab1">疲劳计算器</button>
    <button role="tab" class="tab" id="tab2-btn" aria-selected="false" aria-controls="tab2">填写说明</button>
    <button role="tab" class="tab" id="tab3-btn" aria-selected="false" aria-controls="tab3">CSV 文件合并</button>
    <!-- <button role="tab" class="tab" id="tab4-btn" aria-selected="false" aria-controls="tab4">填写指南</button> -->
  </nav>
  <main>
    <section id="tab1" class="tabpanel" role="tabpanel" aria-labelledby="tab1-btn">
      <div class="alert-box info">
  <div class="alert-title">
    <svg class="icon-info" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18">
      <path fill="#3498db" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 15h-1v-6h2v6h-1zm0-8c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1z"/>
    </svg>
    <strong>注意：</strong>
  </div>
  <div class="alert-message">
    连续填写时，请输入累计疲劳值<br>
    服务器不记录填写内容，请上传 CSV 文件
  </div>
</div>

      <form id="fatigueForm" class="info-form">
        <label>姓名：<input type="text" id="userName" name="userName"></label>
        <label>年龄：
  <input type="number" id="userAge" name="userAge" min="18" max="70" step="1" inputmode="numeric">
</label>
        <label>飞行管理干部：<div class="yesno"><label><input type="radio" name="isManager" value="是"> 是</label>&nbsp;&nbsp;<label><input type="radio" name="isManager" value="否"> 否</label></div></label>
        <label>填报时间：<input type="date" id="reportDate" name="reportDate"></label>
        <label>累计疲劳值：<select id="initialFatigue"></select></label>
      </form>
<div class="table-container">      
<table id="fatigueTable">
  <caption>疲劳评估项目</caption>
<thead>
  <tr>
    <th>序号</th>
    <th>类别</th>
    <th>项目</th>
    <th>是/否</th>
  </tr>
</thead>

  <tbody>
    <!-- 此处由JS动态生成内容 -->
  </tbody>
<tfoot>
  <tr>
    <td colspan="3" style="text-align:right;">单次疲劳值</td>
    <td id="singleScore"></td>
  </tr>
  <tr>
    <td colspan="3" style="text-align:right;">总疲劳值</td>
    <td id="totalScore"></td>
  </tr>
</tfoot>

</table>
</div>
      <fieldset class="voting voting-enhanced" aria-labelledby="voting-legend">
  <legend id="voting-legend">
    <span class="legend-title">体感疲劳度</span>
  </legend>

  <div class="alert-box inline-note">
    <strong>提示：</strong>当选择 <strong>高度疲劳</strong> 时，请及时合并 CSV 文件
  </div>

  <div class="radio-options">
    <label><input type="radio" name="selfFatigue" value="A"> A 不疲劳</label>
    <label><input type="radio" name="selfFatigue" value="B"> B 轻度</label>
    <label><input type="radio" name="selfFatigue" value="C"> C 中度</label>
    <label><input type="radio" name="selfFatigue" value="D"> D 高度</label>
  </div>
</fieldset>


<div class="table-container">    
<table class="symptom-table">
  <caption>体感疲劳度参考</caption>
  <thead>
    <tr>
      <th>症状类型</th>
      <th>飞行轻度疲劳</th>
      <th>飞行中度疲劳</th>
      <th>飞行高度疲劳</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>注意力</td>
      <td>正常、全神贯注</td>
      <td>注意力开始不集中、逐渐出现分配不合理情况</td>
      <td>注意力集中不起来、不能合理分配</td>
    </tr>
    <tr>
      <td>反应力</td>
      <td>能够熟练、准确地完成飞行动作、能力与技术能够正常表现</td>
      <td>反应能力下降、飞行动作有时不稳定</td>
      <td>反应迟钝、容易出现小错误</td>
    </tr>
    <tr>
      <td>兴奋性</td>
      <td>兴奋度高、有持续飞行的愿望</td>
      <td>积极性和兴奋性下降、不想持续飞行</td>
      <td>失去兴奋性、想停下来休息</td>
    </tr>
    <tr>
      <td>情绪</td>
      <td>高昂、愉快、活泼</td>
      <td>有点低落、飞行基本感觉不到愉快</td>
      <td>对飞行产生厌倦</td>
    </tr>
    <tr>
      <td>生理状况</td>
      <td>精力充沛、心率血压正常</td>
      <td>乏力、精神不振、心率血压下降</td>
      <td>头痛、心跳加快、神经失调、有失眠症状</td>
    </tr>
  </tbody>
</table>
</div>
      <button type="button" id="exportBtn" >点此导出为 CSV 文件</button>
<div class="email-info">邮箱地址：N/A</div>
    </section>
    <section id="tab2" class="tabpanel" role="tabpanel" aria-labelledby="tab2-btn" hidden>
      <article class="instructions">
        <h2>填写说明</h2>
        <ol>
          <li><strong>评估范围：</strong>生理性疲劳评估范围为东北地区运输航空公司飞行人员及飞行管理干部，不包括公司级飞行管理干部，先在南航开始试点。</li>
          <li><strong>评估依据：</strong>本指标是在结合《大型飞机公共航空运输承运人运行合格审定规则》（CCAR-121-R8）P章，关于飞行人员休息期、执勤期相关规定的基础上，结合人的生理疲劳特点及个体身体状况制定。考虑到个体差异性和疲劳耐受性，此评估不作为强制停飞依据。</li>
          <li><strong>评估目的：</strong>本指标通过量化评估疲劳阈值，旨在落实《大型飞机公共航空运输航空卫生工作要求》（AC121-FS-101R2）中关于飞行前对机组成员健康状况评估的要求，通过对疲劳指标进行量化，提醒航空公司掌握飞行人员生理性疲劳状况，防范因生理性疲劳引发失能风险；同时鼓励并支持飞行人员主动在疲劳状态“举手”报告，强化疲劳风险防范意识。</li>
          <li><strong>填写方法：</strong>
            <ol style="list-style:none;">
              <li>4.1 填报时间为前一次飞行值勤期结束后至下一个飞行值勤期开始前，评估前一个飞行值勤期情况及飞行值勤前休息情况。</li>
              <li>4.2 操作指南：
                  <ol style="list-style:none;">
                  <li>4.2.1 点选二维码进入页面后，点右上角打开第三方浏览器即可开始逐项填写。</li>
                 <li>4.2.2 填写后，点选“导出为CSV文件”即可保存此次填写。每次填写后必须导出CSV文件并保存。</li>
                 <li>4.2.3 点击“CSV文件合并”，按提示操作即可合并所有已填写并下载的疲劳评估表格。当选择高度疲劳时需进行“CSV文件合并”操作，以保存本人疲劳阈值。</li>
                  </ol>
              <li>4.3 每次填报请务必填写“累计疲劳值”。首次填报时，“累计疲劳值”为0。之后，每次填报，“累计疲劳值”为上一次填报生成的“总疲劳值”。</li>
              <li>4.4 遇有不适用项，该项疲劳评估值为0。</li>
              <li>4.5 若未达到疲劳阈值或未获得休息，疲劳值继续累计计算。</li>
              <li>4.6 累计疲劳值归零情况：
                <ol style="list-style:none;">
                  <li>4.6.1 在值勤前或者主备份前的144小时内，至少获得连续60个小时（含）休息时间的情况。</li>
                  <li>4.6.2 前一个飞行值勤期结束后到下一个飞行值勤期开始前，获得连续休息15小时（含）以上的情况。</li>
                  <li>4.6.3 疲劳举手获得充分休息并恢复到轻度疲劳或不疲劳状态后。</li>
                </ol>
              </li>
            </ol>
          </li>
          <li><strong>相关释义：</strong>
            <ol style="list-style:none;">
              <li>5.1 “连续值勤五天”包括飞行值勤、主备份、置位、模拟机训练和地面培训。</li>
              <li>5.2 本指标评估使用24小时计时制。表中有关时间均指执行任务的当地时间。</li>
              <li>5.3 第 6 条、第 7 条及女性生理期出现任一情况时，鼓励并支持飞行员疲劳“举手”报告。</li>
              <li>5.4 第 10条、第 11 条中“一般高原机场”与“高高原机场”均按南航《运行手册》第 14.4 条定义执行。</li>
              <li>5.5 第 12 条“需特殊机长资格批准机场”按南航《运行规范》C0003 条款批准的机场清单执行。</li>
              <li>5.6 第 17–22 条每次报告疲劳值时进行重复统计。</li>
              <li>5.7 本指标确定的疲劳阈值（高度疲劳值）需先在部分一线飞行员中试行统计得出。</li>
            </ol>
          </li>
        </ol>
      </article>
    </section>
    <section id="tab3" class="tabpanel" role="tabpanel" aria-labelledby="tab3-btn" hidden>
      <article class="instructions">
        <h2>CSV 文件合并</h2>
        <p>请选择表头一致的 CSV 文件后，点击“合并并下载 CSV”按钮：</p>
        <input type="file" id="csvFiles" accept=".csv" multiple>
        <button type="button" id="mergeBtn">合并并下载 CSV</button>
      </article>
    </section>
<section id="tab4" class="tabpanel" role="tabpanel" aria-labelledby="tab4-btn" hidden>
  <article class="instructions" style="max-width:900px;margin:auto;">
    <h2>填写指南</h2>
    <ol>
      <li>
        <strong>疲劳计算器</strong>
        <ol type="a">
          <li><strong>填写基本信息：</strong> 姓名、年龄、是否飞行管理干部、填报时间、累计疲劳值（首次为0，连续填写选上次总疲劳值）。</li>
          <li><strong>22项疲劳项目：</strong> 逐项选择“是/否”，自动算分。</li>
          <li><strong>体感疲劳度：</strong> 选择A~D（旁边表格可参考）。</li>
          <li><strong>导出数据：</strong> 填写完整后点击“点此导出为 CSV 文件”下载数据，自动复制邮箱地址。未填写项会标红提示，需补全后才能导出。</li>
          <li>
            <strong>CSV文件名命名规则：</strong>
              <ol type="i">
              <li>格式为：“姓名_填报日期.csv”</li>
              <li>如姓名为“张三”，填报日期为2024-06-12，则文件名为：张三_2024-06-12.csv</li>
              <li>姓名未填为“未知姓名_日期.csv”；日期未填则用当天日期。</li>
	      </ol>
          </li>
        </ol>
      </li>
      <li>
        <strong>填写说明</strong>
        <ol type="a">
          <li>见页面内容</li>
        </ol>
      </li>
      <li>
        <strong>CSV文件合并</strong>
        <ol type="a">
          <li>支持将多个相同表头的疲劳评估CSV文件进行合并，便于管理和统计。</li>
          <li>操作步骤：</li>
  	  <ol type="i">
	  <li>点击“选择文件”，批量选取待合并的CSV文件。</li>
	  <li>点击“合并并下载 CSV”，自动合成一份大表格，文件名自动带日期与四位随机数。</li>
	  <li>如果遇到表头不一致的文件，软件会自动跳过并提示。</li>
        </ol>
      </li>
      <li>
        <strong>界面功能补充说明</strong>
        <ol type="a">
          <li><strong>红色高亮与浮动提示：</strong>未填写的内容会被高亮显示，提交时会自动提示并阻止导出，填写完整后自动恢复正常。</li>
          <li><strong>表单实时校验：</strong>输入或选择后自动取消高亮，提升填写体验。</li>
          <li><strong>邮箱复制功能：</strong>导出时自动复制指定邮箱，无需手动操作。</li>
          <li><strong>体感疲劳度参考表：</strong>帮助用户自查、准确选择。</li>
        </ol>
      </li>
      <li>
        <strong>常见问题</strong>
        <ol type="a">
          <li><strong>无法导出：</strong>检查红色高亮项并补全。</li>
          <li><strong>企业微信导出CSV文件失败：</strong>目前不支持企业微信导出CSV文件，请使用手机微信</li>
          <li><strong>邮箱无法自动复制：</strong>某些浏览器可能屏蔽自动复制，请手动复制页面下方的邮箱地址。</li>
          <li><strong>文件合并被跳过：</strong>请检查文件表头是否一致。</li>
        </ol>
      </li>
    </ol>
  </article>
</section>
  </main>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const reportDateInput = document.getElementById('reportDate');
      if (reportDateInput && !reportDateInput.value) {
      const today = new Date().toISOString().slice(0, 10); // 格式：YYYY-MM-DD
      reportDateInput.value = today;
      }      
const tabs = document.querySelectorAll('[role="tab"]');
      const panels = document.querySelectorAll('[role="tabpanel"]');
      tabs.forEach(tab => tab.addEventListener('click', () => {
        tabs.forEach(t => t.setAttribute('aria-selected', 'false'));
        panels.forEach(p => p.hidden = true);
        tab.setAttribute('aria-selected', 'true');
        document.getElementById(tab.getAttribute('aria-controls')).hidden = false;
      }));
      const initialSelect = document.getElementById('initialFatigue');
initialSelect.append(new Option('请选择', '')); // 第一个选项为空
for (let i = 0; i <= 200; i++) initialSelect.append(new Option(i, i));
      const items = [
        {label:'连续飞行值勤第3天',unitVal:2,unitText:'2分/天'},
        {label:'连续飞行值勤第4天',unitVal:3,unitText:'3分/天'},
        {label:'连续执勤第五天',unitVal:5,unitText:'5分/次'},
        {label:'06：00（含）前签到或过夜期间05：30（含）前发车',unitVal:1,unitText:'1分/次'},
        {label:'00：00-01：59解除任务',unitVal:2,unitText:'2分/次'},
        {label:'02：00-03：59解除任务',unitVal:4,unitText:'4分/次'},
        {label:'04：00后解除任务',unitVal:5,unitText:'5分/次'},
        {label:'01：00后开始计算的连续10小时但小于15小时的休息期',unitVal:5,unitText:'5分/次'},
        {label:'01：00后开始计算的连续48小时但小于60小时的休息期',unitVal:5,unitText:'5分/次'},
        {label:'一般高原机场',unitVal:1,unitText:'1分/次'},
        {label:'高高原机场',unitVal:2,unitText:'2分/次'},
        {label:'需要特殊机长资格批准机场',unitVal:2,unitText:'2分/次'},
        {label:'连续执勤13小时（含）以上',unitVal:2,unitText:'2分/次'},
        {label:'航班延误2-4（不含）小时',unitVal:1,unitText:'1分/次'},
        {label:'航班延误4-6（不含）小时',unitVal:2,unitText:'2分/次'},
        {label:'航班延误6小时及以上',unitVal:3,unitText:'3分/次'},
        {label:'备降',unitVal:2,unitText:'2分/次'},
        {label:'月度飞行时间≥60小时',unitVal:1,unitText:'1分/次统计'},
        {label:'55-60周岁（含）',unitVal:1,unitText:'1分/次统计'},
        {label:'60周岁（不含）及以上',unitVal:2,unitText:'2分/次统计'},
        {label:'有甲减、肥胖伴脂肪肝及高血脂两项指标异常',unitVal:1,unitText:'1分/次统计'},
        {label:'健康分级3、4级人员',unitVal:2,unitText:'2分/次统计'}
      ];
      const tbody = document.querySelector('#fatigueTable tbody');
const alternateColors = ['#f9fbfd', '#f2f5f9'];
const categoryGroups = [
  { name: '连续飞行或执勤', indices: [0, 1, 2] },
  { name: '签到签出',       indices: [3, 4, 5, 6] },
  { name: '休息期',         indices: [7, 8] },
  { name: '特殊航线',       indices: [9, 10, 11] },
  { name: '航班不正常', indices: [12, 13, 14, 15, 16] },
  { name: '人员',       indices: [17, 18, 19] },
  { name: '身体状况',   indices: [20, 21] }
];

categoryGroups.forEach((group, groupIndex) => {
  const bgColor = alternateColors[groupIndex % 2]; // 蓝绿交替
  group.indices.forEach((i, indexInGroup) => {
    const it = items[i];
    const tr = document.createElement('tr');
    tr.style.backgroundColor = bgColor;

    let groupCellHTML = '';
    if (indexInGroup === 0) {
      groupCellHTML = `<td rowspan="${group.indices.length}" style="
  writing-mode: vertical-rl;
  text-orientation: upright;
  text-align: center;
  vertical-align: middle;
  font-weight: bold;
  font-size: 15px;
  line-height: 1.6;
  padding: 6px 2px;
  background-color: ${bgColor};
  border: 1px solid #ccc;
"
> ${group.name} </td>`;

    }

    tr.innerHTML = `
      <td>${i + 1}</td>
      ${groupCellHTML}
      <td>${it.label}</td>
      <td class="yesno">
        <label><input type="radio" name="item${i}" value="1">是</label>
        &nbsp;&nbsp;<label><input type="radio" name="item${i}" value="0" checked>否</label>
        <span class="score-cell" style="display:none"></span>
      </td>
    `;
    tbody.appendChild(tr);
  });
});
// ✅ 限制第1~3项最多选一个为“是”
[0, 1, 2].forEach(index => {
  const yesRadio = document.querySelector(`input[name="item${index}"][value="1"]`);
  if (yesRadio) {
    yesRadio.addEventListener('change', function () {
      if (this.checked) {
        [0, 1, 2].forEach(otherIndex => {
          if (otherIndex !== index) {
            const otherYes = document.querySelector(`input[name="item${otherIndex}"][value="1"]`);
            const otherNo = document.querySelector(`input[name="item${otherIndex}"][value="0"]`);
            if (otherYes && otherNo) {
              otherYes.checked = false;
              otherNo.checked = true;
            }
          }
        });
        updateScores(); // 重新计算得分
      }
    });
  }
});
// ✅ 限制第5~7项最多选一个为“是”
[4, 5, 6].forEach(index => {
  const yesRadio = document.querySelector(`input[name="item${index}"][value="1"]`);
  if (yesRadio) {
    yesRadio.addEventListener('change', function () {
      if (this.checked) {
        [4, 5, 6].forEach(otherIndex => {
          if (otherIndex !== index) {
            const otherYes = document.querySelector(`input[name="item${otherIndex}"][value="1"]`);
            const otherNo = document.querySelector(`input[name="item${otherIndex}"][value="0"]`);
            if (otherYes && otherNo) {
              otherYes.checked = false;
              otherNo.checked = true;
            }
          }
        });
        updateScores(); // 重新计算得分
      }
    });
  }
});
// ✅ 限制第14~16项最多选一个为“是”
[13, 14, 15].forEach(index => {
  const yesRadio = document.querySelector(`input[name="item${index}"][value="1"]`);
  if (yesRadio) {
    yesRadio.addEventListener('change', function () {
      if (this.checked) {
        [13, 14, 15].forEach(otherIndex => {
          if (otherIndex !== index) {
            const otherYes = document.querySelector(`input[name="item${otherIndex}"][value="1"]`);
            const otherNo = document.querySelector(`input[name="item${otherIndex}"][value="0"]`);
            if (otherYes && otherNo) {
              otherYes.checked = false;
              otherNo.checked = true;
            }
          }
        });
        updateScores(); // 重新计算得分
      }
    });
  }
});

// ✅ 限制第19~20项最多选一个为“是”
[18, 19].forEach(index => {
  const yesRadio = document.querySelector(`input[name="item${index}"][value="1"]`);
  if (yesRadio) {
    yesRadio.addEventListener('change', function () {
      if (this.checked) {
        [18, 19].forEach(otherIndex => {
          if (otherIndex !== index) {
            const otherYes = document.querySelector(`input[name="item${otherIndex}"][value="1"]`);
            const otherNo = document.querySelector(`input[name="item${otherIndex}"][value="0"]`);
            if (otherYes && otherNo) {
              otherYes.checked = false;
              otherNo.checked = true;
            }
          }
        });
        updateScores(); // 重新计算得分
      }
    });
  }
});

     function updateScores() {
  let total = parseFloat(initialSelect.value) || 0;
  let single = 0;
  items.forEach((it, idx) => {
    const val = document.querySelector(`input[name=item${idx}]:checked`).value;
    const score = +val * it.unitVal;
    document.querySelectorAll('.score-cell')[idx].textContent = score;
    single += score;
  });
  document.getElementById('singleScore').textContent = single;
  document.getElementById('totalScore').textContent = total + single;
}
      document.querySelectorAll('.yesno input').forEach(inp => inp.addEventListener('change', updateScores));
      initialSelect.addEventListener('change', updateScores);
     document.getElementById('exportBtn').addEventListener('click', () => {
  let hasError = false;
let firstInvalidElement = null;
  const missingFields = [];

  // 清除高亮
  document.querySelectorAll('.info-form input, .info-form select').forEach(e => {
    e.style.border = '';
    e.style.background = '';
  });
  document.querySelectorAll('.yesno').forEach(div => div.style.background = '');
  document.querySelectorAll('input[name="selfFatigue"]').forEach(inp => {
    inp.parentElement.style.background = '';
  });

  // 基本信息
  const nameInput = document.getElementById('userName');
  const ageInput = document.getElementById('userAge');
  const dateInput = document.getElementById('reportDate');
  const fatigueSelect = document.getElementById('initialFatigue');

  if (!nameInput.value.trim()) {
    nameInput.style.border = '2px solid red';
    hasError = true;
    missingFields.push('姓名');
 if (!firstInvalidElement) firstInvalidElement = nameInput;
  }
  if (!ageInput.value.trim()) {
    ageInput.style.border = '2px solid red';
    hasError = true;
    missingFields.push('年龄');
 if (!firstInvalidElement) firstInvalidElement = ageInput;
  }
else {
  const age = parseInt(ageInput.value, 10);
  if (isNaN(age) || age < 18 || age > 70) {
    ageInput.style.border = '2px solid red';
    hasError = true;
    missingFields.push('年龄必须在18到70之间');
    if (!firstInvalidElement) firstInvalidElement = ageInput;
  }
}
  if (!dateInput.value.trim()) {
    dateInput.style.border = '2px solid red';
    hasError = true;
    missingFields.push('填报时间');
 if (!firstInvalidElement) firstInvalidElement = dateInput;
  }
  if (!fatigueSelect.value) {
    fatigueSelect.style.border = '2px solid red';
    hasError = true;
    missingFields.push('累计疲劳值');
if (!firstInvalidElement) firstInvalidElement = fatigueSelect;
  }

  // 是否飞行管理干部
  const managerRadios = document.querySelectorAll('input[name="isManager"]');
if (![...managerRadios].some(r => r.checked)) {
  managerRadios.forEach(r => r.parentElement.parentElement.style.background = '#ffeaea');
  hasError = true;
  missingFields.push('是否为飞行管理干部');
  if (!firstInvalidElement) firstInvalidElement = managerRadios[0];
}

  // 疲劳项目 22 项
  for (let i = 0; i < 22; i++) {
  const radios = document.querySelectorAll(`input[name="item${i}"]`);
  if (![...radios].some(r => r.checked)) {
    radios.forEach(r => r.parentElement.parentElement.style.background = '#ffeaea');
    hasError = true;
    missingFields.push(`第 ${i + 1} 项`);
    if (!firstInvalidElement) firstInvalidElement = radios[0];
  }
}


  // 体感疲劳度
  const selfFatigueRadios = document.querySelectorAll('input[name="selfFatigue"]');
 if (![...selfFatigueRadios].some(r => r.checked)) {
  selfFatigueRadios.forEach(r => r.parentElement.style.background = '#ffeaea');
  hasError = true;
  missingFields.push('体感疲劳度');
  if (!firstInvalidElement) firstInvalidElement = selfFatigueRadios[0];
}


  // 如果有错误
  if (hasError) {
  if (firstInvalidElement && typeof firstInvalidElement.scrollIntoView === 'function') {
    firstInvalidElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
  }
    const message = `有未填写项目，请完善以下内容：\n- ` + missingFields.join('\n- ');
    showToast(message, 4000);
    return;
  }

  // ======= 校验通过，执行后续导出逻辑 =======
  // ... 你原有的导出CSV代码（比如生成内容/下载/复制邮箱等） ...
  // 这里贴回你的后续逻辑即可
  // 例如：

  const name = nameInput.value.trim();
  const age = ageInput.value.trim();
  const isManager = document.querySelector('input[name="isManager"]:checked').value;
  const date = dateInput.value;
  const initial = fatigueSelect.value;

  // ... header/data/csv构造 ... 

  const fileNameUser = name.replace(/[\\/:*?"<>|,\s]/g, '') || '未知姓名';
  const fileNameDate = date || new Date().toISOString().slice(0,10);

  const singleScore = document.getElementById('singleScore').textContent;
const totalScore = document.getElementById('totalScore').textContent;

const header = [
  '姓名',
  '年龄',
  '是否飞行干部',
  '填报时间',
  '累计疲劳值',
  ...items.map(it => it.label),
  '单次疲劳值',
  '总疲劳值',
  '体感疲劳度'
];

const data = [
  name,
  age,
  isManager,
  date,
  initial,
  ...items.map((_, i) =>
    document.querySelectorAll('.score-cell')[i].textContent
  ),
  singleScore,    // 新增
  totalScore,     // 保持
  document.querySelector('input[name="selfFatigue"]:checked').value
];


  const csv = [header, data].map(row => row.join(',')).join('\n');
  const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = `${fileNameUser}_${fileNameDate}.csv`;

  // 自动复制邮箱
  const email = 'N/A';
  navigator.clipboard.writeText(email);

  link.click();

});


      document.getElementById('mergeBtn').addEventListener('click', () => {
        const files = Array.from(document.getElementById('csvFiles').files);
        if (!files.length) return alert('请先选择 CSV 文件');
        Promise.all(files.map(f => new Promise((res, rej) => {
          const fr = new FileReader();
          fr.onload = () => res(fr.result.split(/\r?\n/));
          fr.onerror = () => rej(fr.error);
          fr.readAsText(f, 'utf-8');
        }))).then(all => {
          const header = all[0][0], merged=[header], skipped=[];
          all.forEach((lines,i) => {
            if (lines[0] === header) merged.push(...lines.slice(1).filter(Boolean));
            else skipped.push(files[i].name);
          });
          if (skipped.length) alert('以下文件已跳过：\n'+skipped.join('\n'));
          const blob = new Blob(['\uFEFF'+merged.join('\n')], {type:'text/csv;charset=utf-8;'});
          const link = document.createElement('a'); link.href = URL.createObjectURL(blob);
         const randomNum = Math.floor(1000 + Math.random() * 9000); // 1000~9999的四位数
link.download = `merged_${new Date().toISOString().slice(0,10)}_${randomNum}.csv`;
          link.click();
        }).catch(e => alert('合并出错:'+e));
      });
    });
function showToast(msg, duration=2500) {
  const toast = document.getElementById('toast');
  toast.innerHTML = msg.replace(/\n/g, '<br>');
  toast.style.display = 'block';
  clearTimeout(showToast._timer);
  showToast._timer = setTimeout(() => {
    toast.style.display = 'none';
  }, duration);
}
// 输入框/下拉框即时校验
['userName', 'userAge', 'reportDate'].forEach(id => {
  document.getElementById(id).addEventListener('input', function() {
    if (this.value.trim()) {
      this.style.border = '';
      this.style.background = '';
    }
  });
});
document.getElementById('userAge').addEventListener('input', function () {
  const age = parseInt(this.value, 10);

  const item18_row = document.querySelectorAll('input[name="item18"]')[0].closest('tr');
  const item19_row = document.querySelectorAll('input[name="item19"]')[0].closest('tr');
  const item18_radios = document.querySelectorAll('input[name="item18"]');
  const item19_radios = document.querySelectorAll('input[name="item19"]');

  // 统一处理勾选与锁定
  function lockRadio(radios, value) {
    radios.forEach(r => {
      r.checked = (r.value === value);
      r.disabled = true;
    });
  }

  function unlockRadio(radios) {
    radios.forEach(r => {
      r.disabled = false;
    });
  }

  function setRowReadonly(row, isReadonly) {
    row.style.backgroundColor = isReadonly ? '#f8f8f8' : ''; // 灰色背景
    row.style.opacity = isReadonly ? '0.6' : '1';
    row.style.pointerEvents = isReadonly ? 'none' : 'auto';  // 阻止鼠标操作
  }

  if (!isNaN(age)) {
    // 锁定并根据年龄设置“是/否”
    if (age >= 55 && age <= 60) {
      lockRadio(item18_radios, '1');
    } else {
      lockRadio(item18_radios, '0');
    }

    if (age > 60) {
      lockRadio(item19_radios, '1');
    } else {
      lockRadio(item19_radios, '0');
    }

    // 设置灰色行样式（只读效果）
    setRowReadonly(item18_row, true);
    setRowReadonly(item19_row, true);

  } else {
    // 恢复用户可选
    unlockRadio(item18_radios);
    unlockRadio(item19_radios);
    setRowReadonly(item18_row, false);
    setRowReadonly(item19_row, false);
  }

  updateScores(); // 自动刷新得分
});

document.getElementById('initialFatigue').addEventListener('change', function() {
  if (this.value) {
    this.style.border = '';
    this.style.background = '';
  }
});

// 飞行管理干部单选
document.querySelectorAll('input[name="isManager"]').forEach(radio => {
  radio.addEventListener('change', function() {
    radio.parentElement.parentElement.style.background = '';
  });
});

// 疲劳评估项目
for(let i=0; i<22; i++){
  document.querySelectorAll(`input[name="item${i}"]`).forEach(radio => {
    radio.addEventListener('change', function() {
      radio.parentElement.parentElement.style.background = '';
    });
  });
}

// 体感疲劳度
document.querySelectorAll('input[name="selfFatigue"]').forEach(radio => {
  radio.addEventListener('change', function() {
    document.querySelectorAll('input[name="selfFatigue"]').forEach(inp => {
      inp.parentElement.style.background = '';
    });
  });
});
// 限制项目0~2最多只能一个为“是”
[0, 1, 2].forEach(index => {
  const yesRadio = document.querySelector(`input[name="item${index}"][value="1"]`);
  if (yesRadio) {
    yesRadio.addEventListener('change', function () {
      if (this.checked) {
        [0, 1, 2].forEach(otherIndex => {
          if (otherIndex !== index) {
            const otherYes = document.querySelector(`input[name="item${otherIndex}"][value="1"]`);
            const otherNo = document.querySelector(`input[name="item${otherIndex}"][value="0"]`);
            if (otherYes && otherNo) {
              otherYes.checked = false;
              otherNo.checked = true;
            }
          }
        });
        updateScores(); // 重新计算得分
      }
    });
  }
});
// ✅ 限制第6~8项（编号5~7）最多选一个为“是”
[5, 6, 7].forEach(index => {
  const yesRadio = document.querySelector(`input[name="item${index}"][value="1"]`);
  if (yesRadio) {
    yesRadio.addEventListener('change', function () {
      if (this.checked) {
        [5, 6, 7].forEach(otherIndex => {
          if (otherIndex !== index) {
            const otherYes = document.querySelector(`input[name="item${otherIndex}"][value="1"]`);
            const otherNo = document.querySelector(`input[name="item${otherIndex}"][value="0"]`);
            if (otherYes && otherNo) {
              otherYes.checked = false;
              otherNo.checked = true;
            }
          }
        });
        updateScores();
      }
    });
  }
});

  </script>
<div id="toast" style="
  display:none;
  position: fixed;
  left: 50%;
  bottom: 60px;
  transform: translateX(-50%);
  min-width: 240px;
  max-width: 80%;
  background: rgba(41, 128, 185, 0.65); /* 半透明深蓝 */
  backdrop-filter: blur(4px);           /* 背景模糊 */
  -webkit-backdrop-filter: blur(4px);   /* 兼容 Safari */
  border-left: 6px solid #1abc9c;
  color: #fff;
  padding: 14px 28px;
  border-radius: 8px;
  font-size: 16px;
  text-align: center;
  z-index: 9999;
  box-shadow: 0 4px 24px rgba(0,0,0,0.16);
  white-space: pre-wrap;
  word-break: keep-all;
  "></div>
</body>
</html>
